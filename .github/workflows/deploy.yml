name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to OCI
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            set -e
            DEPLOY_PATH=${{ secrets.OCI_DEPLOY_PATH }}
            cd $DEPLOY_PATH
            if [ -d .git ]; then
              rm -rf .git
            fi
            cd ..
            rm -rf psgrammers_temp
            git clone https://github.com/Jyeon324/psgrammers.git psgrammers_temp
            rm -rf psgrammers_old
            mv psgrammers psgrammers_old 2>/dev/null || true
            mv psgrammers_temp psgrammers
            docker compose -f $DEPLOY_PATH/psgrammers/deploy/docker-compose.prod.yml pull
            docker compose -f $DEPLOY_PATH/psgrammers/deploy/docker-compose.prod.yml up -d --build
            docker image prune -f
            cd deploy
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --build
            docker image prune -f

      - name: Health check
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            sleep 30
            if docker ps --filter "name=psgrammers-backend" --filter "status=running" | grep -q psgrammers-backend; then
              echo "Backend is running"
            else
              echo "Backend failed to start"
              docker logs psgrammers-backend --tail 50
              exit 1
            fi
            if docker ps --filter "name=psgrammers-frontend" --filter "status=running" | grep -q psgrammers-frontend; then
              echo "Frontend is running"
            else
              echo "Frontend failed to start"
              docker logs psgrammers-frontend --tail 50
              exit 1
            fi
