name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to OCI
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            set -e
            DEPLOY_PATH=${{ secrets.OCI_DEPLOY_PATH }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            PARENT_PATH=$(dirname $DEPLOY_PATH)
            REPO_NAME=$(basename $DEPLOY_PATH)
            if [ -z "$POSTGRES_USER" ]; then
              POSTGRES_USER=postgres
            fi
            if [ -z "$POSTGRES_PASSWORD" ]; then
              POSTGRES_PASSWORD=postgres
            fi
            mkdir -p $PARENT_PATH
            if [ -d "$DEPLOY_PATH/.git" ]; then
              cd $DEPLOY_PATH
              git fetch origin main
              git reset --hard origin/main
            elif [ -d "$DEPLOY_PATH" ]; then
              cd $DEPLOY_PATH
              git init
              git remote remove origin || true
              git remote add origin https://github.com/Jyeon324/psgrammers.git
              git fetch origin main
              git checkout -f -B main origin/main
            else
              cd $PARENT_PATH
              git clone https://github.com/Jyeon324/psgrammers.git $REPO_NAME
            fi
            cd $DEPLOY_PATH/deploy
            printf "POSTGRES_USER=%s\nPOSTGRES_PASSWORD=%s\n" "$POSTGRES_USER" "$POSTGRES_PASSWORD" > .env
            chmod 600 .env
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --build
            docker image prune -f

      - name: Health check
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.OCI_HOST }}
          username: ${{ secrets.OCI_USER }}
          key: ${{ secrets.OCI_SSH_KEY }}
          script: |
            sleep 30
            if docker ps --filter "name=psgrammers-backend" --filter "status=running" | grep -q psgrammers-backend; then
              echo "Backend is running"
            else
              echo "Backend failed to start"
              docker logs psgrammers-backend --tail 50
              exit 1
            fi
            if docker ps --filter "name=psgrammers-frontend" --filter "status=running" | grep -q psgrammers-frontend; then
              echo "Frontend is running"
            else
              echo "Frontend failed to start"
              docker logs psgrammers-frontend --tail 50
              exit 1
            fi
